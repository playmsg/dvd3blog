---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import FormattedDate from '../../components/FormattedDate.astro';

export async function getStaticPaths({ paginate }) {
	const allPosts = (await getCollection('blog')).sort(
		(a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
	);
	
	return paginate(allPosts, { pageSize: 10 });
}

// --- 修改 #1：将 totalPages 重命名为 lastPage ---
const { page } = Astro.props;
const { data: posts, currentPage, lastPage, url } = page;

const featuredPost = currentPage === 1 ? posts[0] : null;
const otherPosts = currentPage === 1 ? posts.slice(1) : posts;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			/* 样式完全保持不变 */
			body {
				background-color: #f5f5f7;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
			}
			main { padding-top: 2rem; padding-bottom: 4rem; }
			.posts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; list-style-type: none; margin: 0; padding: 0; }
			.card { display: block; background: #ffffff; border-radius: 18px; text-decoration: none; color: inherit; overflow: hidden; transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); border: 1px solid rgba(0, 0, 0, 0.05); }
			.card:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
			.card-image { width: 100%; aspect-ratio: 16 / 9; overflow: hidden; }
			.card-image img { width: 100%; height: 100%; object-fit: cover; }
			.card-content { padding: 2rem; }
			.title { margin: 0 0 0.5rem 0; color: #1d1d1f; font-weight: 600; line-height: 1.3; }
			.date { font-size: 0.9rem; margin: 0; color: #6e6e73; }
			.featured-post { margin-bottom: 2rem; }
			.featured-post .title { font-size: 2.5rem; }
			.posts-grid .title { font-size: 1.25rem; }
			.pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 3rem; }
			.pagination a { display: inline-block; padding: 0.5rem 1rem; background-color: white; border: 1px solid rgb(var(--gray-light)); border-radius: 8px; text-decoration: none; color: var(--accent); font-weight: 600; }
			.pagination a:hover { background-color: #f5f5f7; }
			.pagination .current-page { color: rgb(var(--gray-dark)); font-weight: 600; }
			.pagination .disabled { opacity: 0.5; pointer-events: none; }

			@media (max-width: 960px) {
				.posts-grid { grid-template-columns: 1fr; }
				.featured-post .title { font-size: 2rem; }
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			{featuredPost && (
				<a href={`/blog/${featuredPost.id}/`} class="card featured-post">
					{featuredPost.data.heroImage && (
						<div class="card-image"> <img src={featuredPost.data.heroImage} alt="" /> </div>
					)}
					<div class="card-content">
						<h2 class="title">{featuredPost.data.title}</h2>
						<p class="date"> <FormattedDate date={featuredPost.data.date} /> </p>
					</div>
				</a>
			)}

			<ul class="posts-grid">
				{otherPosts.map((post) => (
					<li>
						<a href={`/blog/${post.id}/`} class="card">
							{post.data.heroImage && (
								<div class="card-image"> <img src={post.data.heroImage} alt="" /> </div>
							)}
							<div class="card-content">
								<h4 class="title">{post.data.title}</h4>
								<p class="date"> <FormattedDate date={post.data.date} /> </p>
							</div>
						</a>
					</li>
				))}
			</ul>

			<nav class="pagination">
				<a href={url.prev} class:list={{ disabled: !url.prev }}>
					&larr; 上一页
				</a>
				
				<span class="current-page">
					{/* --- 修改 #2：将 totalPages 修改为 lastPage --- */}
					第 {currentPage} 页 / 共 {lastPage} 页
				</span>
				
				<a href={url.next} class:list={{ disabled: !url.lext }}>
					下一页 &rarr;
				</a>
			</nav>

		</main>
		<Footer />
	</body>
</html>